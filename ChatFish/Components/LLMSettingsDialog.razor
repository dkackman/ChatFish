@inherits FloatingComponent
@inject IJSRuntime JSRuntime
@implements IDisposable

@if (IsVisible)
{
    <div class="@GetPositionClasses()">
        <div class="floating-component" role="dialog" aria-modal="true">
            <div class="floating-header">
                <strong class="me-auto">Configure Chat LLM Settings</strong>
                @if (ShowCloseButton)
                {
                    <button type="button" class="btn-close custom-close floating-close" @onclick="CloseComponent"
                        aria-label="Close"></button>
                }
            </div>
            <div class="floating-body">
                <div class="download-container">
                    <select id="model-selection" @bind="selectedModel">
                        @foreach (var model in availableModels)
                        {
                            <option value="@model">@model</option>
                        }
                    </select>
                    <button id="download" @onclick="InitializeWebLLMEngine">Download</button>
                </div>
                <p id="download-status" class="@(isDownloadStatusVisible ? "" : "hidden")">@downloadStatus</p>
            </div>
        </div>
    </div>
}

@code {
    private List<string> availableModels = new List<string>();
    private string selectedModel = "Llama-3.2-1B-Instruct-q4f16_1-MLC";
    private string downloadStatus = "";
    private bool isDownloadStatusVisible = false;
    private DotNetObjectReference<LLMSettingsDialog>? _dotNetRef;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            availableModels = await JSRuntime.InvokeAsync<List<string>>("getAvailableModels");
        }
        catch (JSException)
        {
            Console.WriteLine("Failed to get available models. Using default.");
            availableModels = new List<string> { selectedModel };
        }
    }

    private async Task InitializeWebLLMEngine()
    {
        isDownloadStatusVisible = true;
        try
        {
            await JSRuntime.InvokeVoidAsync("initializeWebLLMEngine", selectedModel, _dotNetRef);
        }
        catch (JSException ex)
        {
            Console.WriteLine($"Failed to initialize WebLLM engine: {ex.Message}");
            downloadStatus = "Failed to initialize WebLLM engine. Please try again.";
        }
    }

    [JSInvokable]
    public void UpdateEngineInitProgress(string text, double progress)
    {
        downloadStatus = $"{text} - {progress:P0}";
        StateHasChanged();
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }
}
<style>
    #model-selection,
    #download {
        width: 100%;
        margin-bottom: 10px;
        padding: 5px;
        border-radius: 5px;
        border: 1px solid rgba(255, 255, 255, 0.6);
        background-color: rgba(255, 255, 255, 0.4);
    }

    #download {
        cursor: pointer;
    }

    #download-status {
        margin-top: 10px;
    }

    .hidden {
        display: none;
    }
</style>